<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>WASM Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
	<script src="main.js"></script>
    <script>

	const solveSudoku = Module.cwrap("solveSudoku", "number", ["number"]); 
	const initSolver = Module.cwrap("initSolver", "number", ["number"]); 

	var sudoku;

	function flat(sudoku){
		const input = sudoku;
		var output = [];
		input.forEach( row =>{
			row.forEach(val =>{
				output.push(val);
			})
		})
		return output;
	}

	function blowup(input, w, h){
		var output = [];
		var i = 0;
		for (var x = 0; x < w; x++){
			output.push([])
			for (var y = 0; y < h; y++){
				output[x].push(input[i++]);
			}
		}
		return output;
	}

	function generateSudoku(){
	const s = [
		[0, 4, 0, 9, 0, 0, 3, 8, 0],
		[6, 0, 0, 0, 0, 0, 0, 9, 0],
		[2, 9, 0, 3, 7, 4, 5, 0, 0],
		[0, 1, 7, 0, 9, 6, 0, 2, 3],
		[0, 0, 0, 2, 0, 0, 0, 5, 4],
		[8, 0, 4, 7, 0, 0, 0, 0, 0],
		[0, 0, 2, 5, 3, 0, 9, 0, 8],
		[4, 0, 0, 0, 2, 7, 6, 0, 1],
		[0, 8, 1, 0, 0, 0, 2, 7, 0],
	]
		//impossible puzzle for testing
//		const s = [
//			[1, 4, 1, 9, 1, 1, 3, 8, 0],
//			[6, 0, 0, 0, 0, 0, 1, 9, 0],
//			[2, 9, 0, 3, 7, 4, 5, 0, 0],
//			[0, 1, 7, 0, 9, 6, 1, 2, 3],
//			[0, 0, 0, 2, 0, 1, 1, 5, 4],
//			[8, 0, 4, 7, 0, 1, 1, 0, 0],
//			[0, 0, 2, 5, 3, 1, 9, 0, 8],
//			[4, 0, 0, 0, 2, 7, 6, 0, 1],
//			[0, 8, 1, 0, 0, 0, 2, 7, 0],
//		]
		return s;
	}

	function displaySudoku(input, dstElement){
		while( dstElement.hasChildNodes() ){
			dstElement.removeChild(dstElement.lastChild);
		}
		
		var x = 0, y =0;
		input.forEach(row => {
			var elemRow = document.createElement("div");
			row.forEach(val => {
				element = document.createElement("span");
				element.setAttribute('data-x', x++);
				element.setAttribute('data-y', y);
				element.innerText = val;
				elemRow.append(element);
			})
			y++;
			x = 0;
			dstElement.append(elemRow);
		});
	}

	function setSudokuClickListeners()
	{
		elem = document.getElementById("sudoku-wrapper");
		
	}

	function printState(ptr)
	{
		var state = [];
		for (var i = 0; i < 81; i++){
			state.push(Module.getValue(ptr + i * 4, "i32"));
		}
		
		displaySudoku(blowup(state, 9, 9),  document.getElementById("solution-wrapper"));
	}

	function solve(sudoku, showSteps = false){
		const len = 81;
		const input = flat(sudoku);

		var ptr = Module._malloc(len * 4);

		for (var i = 0; i < len; i++){
			Module.setValue(ptr + i * 4, input[i], "i32");
		}

		let fnPtr = 0;
		if (showSteps){
			fnPtr = Module.addFunction(function(){
				printState(solutionPtr);
				debugger;
			}, 'v');
		}

		const solutionPtr = initSolver(ptr);

		var solution = [];
		if (!solveSudoku(fnPtr)){
			document.getElementById("solution-wrapper").style.color = "red";
		} else {
			document.getElementById("solution-wrapper").style.color = "green";
		}
		printState(solutionPtr);
		
		Module._free(ptr);
		Module._free(solutionPtr);

	}

	function setupEventListeners(){
		document.querySelectorAll("[data-x]").forEach(elem =>{
			elem.addEventListener('click', e =>{
				const selected = document.getElementsByClassName("selected");
				if (selected.length > 0){
					selected[0].classList.remove("selected");
				}

				
				e.target.classList.add("selected");
			})
		})

		document.addEventListener('keydown', (e) => {
			if (e.keyCode  > 48 && e.keyCode < 58){
				const selected = document.getElementsByClassName("selected")
				if (selected.length > 0){
					const selectedCell = selected[0];
					const val =  e.keyCode - 48;
					selectedCell.innerText = val;
					sudoku[selectedCell.getAttribute('data-x')][selectedCell.getAttribute('data-y')] = val;
					e.target.classList.remove("selected");
				}
			}
		})

		document.getElementById("solve-button").addEventListener('click', solve.bind(null, sudoku, false));
		document.getElementById("steps-button").addEventListener('click',solve.bind(null, sudoku, true));
	}
	
	Module.onRuntimeInitialized = function(){		
		sudoku = generateSudoku();
		displaySudoku(sudoku, document.getElementById("sudoku-wrapper"));
		setupEventListeners();
	}
	
	</script>
	<div>
		<div id=sudoku-wrapper class=sudoku-wrapper></div>
		<div id=solution-wrapper class=sudoku-wrapper></div>
	</div>
	<button id="steps-button">show steps</button>
	<button id="solve-button">solve</button> 
	<br/>
	(showing steps requires open debugger)

</body>
</html>